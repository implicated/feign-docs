<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring 整合 Feign 原理 :: Implicated</title>
    <link rel="canonical" href="https://docs.implicated.com/open-feign/spring-cloud-open-feign/spring-feign-integrations.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.implicated.com">Implicated</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
<!--    <div id="topbar-nav" class="navbar-menu">-->
<!--      <div class="navbar-end">-->
<!--        <a class="navbar-item" href="#">Home</a>-->
<!--        <div class="navbar-item has-dropdown is-hoverable">-->
<!--          <a class="navbar-link" href="#">Products</a>-->
<!--          <div class="navbar-dropdown">-->
<!--            <a class="navbar-item" href="#">Product A</a>-->
<!--            <a class="navbar-item" href="#">Product B</a>-->
<!--            <a class="navbar-item" href="#">Product C</a>-->
<!--          </div>-->
<!--        </div>-->
<!--        <div class="navbar-item has-dropdown is-hoverable">-->
<!--          <a class="navbar-link" href="#">Services</a>-->
<!--          <div class="navbar-dropdown">-->
<!--            <a class="navbar-item" href="#">Service A</a>-->
<!--            <a class="navbar-item" href="#">Service B</a>-->
<!--            <a class="navbar-item" href="#">Service C</a>-->
<!--          </div>-->
<!--        </div>-->
<!--        <div class="navbar-item">-->
<!--          <span class="control">-->
<!--            <a class="button is-primary" href="#">Download</a>-->
<!--          </span>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="open-feign" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Learn OpenFeign</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">基本介绍</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Feign</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../feign/feign-component.html">Feign 的组成</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../feign/feign-core.html">Feign 的核心流程</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../feign/feign-optimize.html">Feign 的性能优化</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../feign/feign-future.html">Feign 的未来</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Spring Cloud Open Feign</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="spring-feign-integrations.html">Spring 整合 Feign 原理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="spring-mvc-support.html">SpringMVC 注解支持原理</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ref.html">参考文档</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<!--<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Learn OpenFeign</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Learn OpenFeign</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
-->
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Learn OpenFeign</a></li>
    <li>Spring Cloud Open Feign</li>
    <li><a href="spring-feign-integrations.html">Spring 整合 Feign 原理</a></li>
  </ul>
</nav>
<!---->
<!--  -->
<!--  <div class="edit-this-page"><a href="https://github.com/implicated/feign-docs/edit/master/docs/modules/ROOT/pages/spring-cloud-open-feign/spring-feign-integrations.adoc">Edit this Page</a></div>-->
<!--  -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Spring 整合 Feign 原理</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>基本流程：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用 <code>FeignClientsRegistrar</code> 扫包并</p>
<div class="ulist">
<ul>
<li>
<p>注入 <code>FeignClient</code> 配置信息(实际是注入 <code>FeignClientFactoryBean</code>)</p>
</li>
<li>
<p>注入 <code>FeignClient</code> (实际是注入 <code>FeignClientFactoryBean</code>)</p>
</li>
</ul>
</div>
</li>
<li>
<p>使用 <code>FeignClientFactoryBean</code> 和 <code>FeignClientFactoryBean</code> 为每个 <code>@FeignClient</code> 标记的类创建子容器，每个容器相互隔离，都拥有完整的 <code>FeignClient</code> 配置信息</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>核心类：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">FeignClientFactoryBean</th>
<th class="tableblock halign-left valign-top">FeignContext</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="imageblock">
<div class="content">
<img src="../_images/feign-client-factory-bean.png" alt="feign client factory bean">
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="imageblock">
<div class="content">
<img src="../_images/feign-context.png" alt="feign context">
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_入口"><a class="anchor" href="#_入口"></a>入口</h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title"><code>org.springframework.cloud.openfeign.EnableFeignClients</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@Documented
@Import(FeignClientsRegistrar.class) <i class="conum" data-value="1"></i><b>(1)</b>
public @interface EnableFeignClients {
   // ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>导入 FeignClient 注入器</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feignclient_注入器"><a class="anchor" href="#_feignclient_注入器"></a>FeignClient 注入器</h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignClientsRegistrar</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
public void registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {
    registerDefaultConfiguration(metadata, registry); <i class="conum" data-value="1"></i><b>(1)</b>
    registerFeignClients(metadata, registry); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>注入 <code>@EnableFeignClients</code> 的全局默认配置（defaultConfiguration）</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>注入 <code>@FeignClient</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_注入_enablefeignclients"><a class="anchor" href="#_注入_enablefeignclients"></a>注入 <code>@EnableFeignClients</code></h3>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignClientsRegistrar#registerDefaultConfiguration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private void registerClientConfiguration(BeanDefinitionRegistry registry, Object name,
            Object configuration) {
    BeanDefinitionBuilder builder = BeanDefinitionBuilder
            .genericBeanDefinition(FeignClientSpecification.class);
    builder.addConstructorArgValue(name);
    builder.addConstructorArgValue(configuration);
    // 注入 FeignClientSpecification （包含 ）EnableFeignClients.defaultConfiguration
    registry.registerBeanDefinition(
            name + "." + FeignClientSpecification.class.getSimpleName(),
            builder.getBeanDefinition());
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_注入_feignclient"><a class="anchor" href="#_注入_feignclient"></a>注入 <code>@FeignClient</code></h3>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignClientsRegistrar#registerFeignClients</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void registerFeignClients(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {
    // 获取ClassPath扫描器
    ClassPathScanningCandidateComponentProvider scanner = getScanner();
    // 为扫描器设置资源加载器
    scanner.setResourceLoader(this.resourceLoader);

    Set&lt;String&gt; basePackages;

    // 获取 @EnableFeignClients 注解的属性 map
    Map&lt;String, Object&gt; attrs = metadata
            .getAnnotationAttributes(EnableFeignClients.class.getName());
    AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(
            FeignClient.class);
    // 获取 @EnableFeignClients 注解的 clients 属性
    final Class&lt;?&gt;[] clients = attrs == null ? null
            : (Class&lt;?&gt;[]) attrs.get("clients");
    // 如果 @EnableFeignClients 注解未指定 clients 属性则扫描添加（扫描过滤条件为：标记有 @FeignClient 的类）
    if (clients == null || clients.length == 0) {
        scanner.addIncludeFilter(annotationTypeFilter);
        basePackages = getBasePackages(metadata);
    }
    // 如果 @EnableFeignClients 注解已指定 clients 属性，则直接添加，不再扫描（从这里可以看出，为了加快容器启动速度，建议都指定 clients 属性）
    else {
        final Set&lt;String&gt; clientClasses = new HashSet&lt;&gt;();
        basePackages = new HashSet&lt;&gt;();
        for (Class&lt;?&gt; clazz : clients) {
            basePackages.add(ClassUtils.getPackageName(clazz));
            clientClasses.add(clazz.getCanonicalName());
        }
        // 过滤标记有 @FeignClient 的类
        AbstractClassTestingTypeFilter filter = new AbstractClassTestingTypeFilter() {
            @Override
            protected boolean match(ClassMetadata metadata) {
                String cleaned = metadata.getClassName().replaceAll("\\$", ".");
                return clientClasses.contains(cleaned);
            }
        };
        scanner.addIncludeFilter(
                new AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));
    }

    // 遍历最终获取到的 @FeignClient 注解类的集合
    for (String basePackage : basePackages) {
        Set&lt;BeanDefinition&gt; candidateComponents = scanner
                .findCandidateComponents(basePackage);
        for (BeanDefinition candidateComponent : candidateComponents) {
            if (candidateComponent instanceof AnnotatedBeanDefinition) {
                // 验证带注释的类必须是接口，不是接口则直接抛出异常
                // verify annotated class is an interface
                AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;
                AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();
                Assert.isTrue(annotationMetadata.isInterface(),
                        "@FeignClient can only be specified on an interface");

                // 获取 @FeignClient 注解的属性值
                Map&lt;String, Object&gt; attributes = annotationMetadata
                        .getAnnotationAttributes(
                                FeignClient.class.getCanonicalName());

                // 获取 clientName 的值，也就是在构造器的参数值
                String name = getClientName(attributes);
                // 同上一个方法最后调用的方法，注入 @FeignClient中的configuration对象到容器中，name：name.feignClientSpecification
                registerClientConfiguration(registry, name, attributes.get("configuration"));

                // 循环注入 @FeignClient 对象，name：className
                registerFeignClient(registry, annotationMetadata, attributes);

            }
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignClientsRegistrar#registerFeignClient</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private void registerFeignClient(BeanDefinitionRegistry registry, AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) { // 获取类名称
    String className = annotationMetadata.getClassName();
    // BeanDefinitionBuilder的主要作用就是构建一个AbstractBeanDefinition,AbstractBeanDefinition类最终被构建成一个BeanDefinitionHolder然后注册到Spring中
    // 注意：beanDefinition类为FeignClientFactoryBean，故在Spring获取类的时候实际返回的是FeignClientFactoryBean类
    BeanDefinitionBuilder definition = BeanDefinitionBuilder
            .genericBeanDefinition(FeignClientFactoryBean.class);
    validate(attributes);
    // 添加FeignClientFactoryBean的属性，
    definition.addPropertyValue("url", getUrl(attributes));
    definition.addPropertyValue("path", getPath(attributes));
    String name = getName(attributes);
    definition.addPropertyValue("name", name);
    // Feign 容器名称
    String contextId = getContextId(attributes);
    definition.addPropertyValue("contextId", contextId);
    definition.addPropertyValue("type", className);
    definition.addPropertyValue("decode404", attributes.get("decode404"));
    definition.addPropertyValue("fallback", attributes.get("fallback"));
    definition.addPropertyValue("fallbackFactory", attributes.get("fallbackFactory"));
    definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);

    // 设置别名
    String alias = contextId + "FeignClient";
    AbstractBeanDefinition beanDefinition = definition.getBeanDefinition();

    boolean primary = (Boolean) attributes.get("primary"); // has a default, won't be
                                                            // null

    beanDefinition.setPrimary(primary);

    String qualifier = getQualifier(attributes);
    if (StringUtils.hasText(qualifier)) {
        alias = qualifier;
    }

    // 定义BeanDefinitionHolder，name是 Feign标记的className
    BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className,
            new String[] { alias });
    // 注入FeignClientFactoryBean
    BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feignclientfactorybean"><a class="anchor" href="#_feignclientfactorybean"></a>FeignClientFactoryBean</h2>
<div class="sectionbody">
<div class="paragraph">
<p>注册 <code>FeignClientFactoryBean</code> 时，会把 <code>getObject()</code> 方法返回的对象注入到 Spring 容器中</p>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignClientFactoryBean#getObject</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
public Object getObject() throws Exception {
    // 返回jdk动态代理，最终注入 Spring 容器的是每个 @FeignClient 标记接口的代理类
    return getTarget();
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_gettarget"><a class="anchor" href="#_gettarget"></a><code>getTarget()</code></h3>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignClientFactoryBean#getTarget</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">&lt;T&gt; T getTarget() {
    // FeignContext 容器，所有配置信息都丛这里取
    // 从 FeignAutoConfiguration 注入
    FeignContext context = this.applicationContext.getBean(FeignContext.class); <i class="conum" data-value="1"></i><b>(1)</b>
    Feign.Builder builder = feign(context);

    // 未指定 url 属性
    if (!StringUtils.hasText(this.url)) {
        if (!this.name.startsWith("http")) {
            this.url = "http://" + this.name;
        }
        else {
            this.url = this.name;
        }
        // 格式化 url
        this.url += cleanPath();
        // HystrixTargeter.target
        // url 是 name (服务名)，根据服务名去负载均衡
        return (T) loadBalance(builder, context,
                new HardCodedTarget&lt;&gt;(this.type, this.name, this.url)); <i class="conum" data-value="2"></i><b>(2)</b>
    }
    // 指定 url 属性（url协议头不是必须的)
    if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith("http")) {
        this.url = "http://" + this.url;
    }
    // 格式化 url
    String url = this.url + cleanPath();
    // 获取 http client
    Client client = getOptional(context, Client.class); <i class="conum" data-value="4"></i><b>(4)</b> <i class="conum" data-value="5"></i><b>(5)</b>
    if (client != null) {
        if (client instanceof LoadBalancerFeignClient) {
            // not load balancing because we have a url,
            // but ribbon is on the classpath, so unwrap
            client = ((LoadBalancerFeignClient) client).getDelegate();
        }
        if (client instanceof FeignBlockingLoadBalancerClient) {
            // not load balancing because we have a url,
            // but Spring Cloud LoadBalancer is on the classpath, so unwrap
            client = ((FeignBlockingLoadBalancerClient) client).getDelegate();
        }
        builder.client(client);
    }
    Targeter targeter = get(context, Targeter.class); <i class="conum" data-value="4"></i><b>(4)</b>
    // DefaultTargeter.target()
    // url 是 @FeignClient 中指定的 URL
    return (T) targeter.target(this, builder, context,
            new HardCodedTarget&lt;&gt;(this.type, this.name, url)); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>注入 <code>FeignContext</code>，入口在 <code>FeignAutoConfiguration</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>如果配置了 Hystrix，执行此方法
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">protected &lt;T&gt; T loadBalance(Feign.Builder builder,
                            FeignContext context,
                            HardCodedTarget&lt;T&gt; target) {
    Client client = getOptional(context, Client.class);
    if (client != null) {
        builder.client(client);
        Targeter targeter = get(context, Targeter.class);
        return targeter.target(
            this, builder, context, target);
    }

    throw new IllegalStateException(
        "No Feign Client for loadBalancing defined. " +
            "Did you forget to include " +
            "spring-cloud-starter-netflix-ribbon?");
}</code></pre>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>默认执行的方法</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>get()</code> 和 <code>getOptional()</code> 都是从 Feign 容器中去获取需要的类。其中通过 <code>get()</code> 方法获取的类不能为空。
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">protected &lt;T&gt; T get(FeignContext context, Class&lt;T&gt; type) { <i class="conum" data-value="4"></i><b>(4)</b>
    // contextId 是容器名称，type 是要获取的类
    T instance = context.getInstance(this.contextId, type);
    if (instance == null) {
        throw new IllegalStateException(
                "No bean found of type " + type + " for " +
                this.contextId);
    }
    return instance;
}

protected &lt;T&gt; T getOptional(FeignContext context,Class&lt;T&gt; type) { <i class="conum" data-value="4"></i><b>(4)</b>
    return context.getInstance(this.contextId, type);
}</code></pre>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>Feign</code> 默认的 <code>http client</code> 是 <code>java.net.HttpURLConnection</code>。</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_targeter_target"><a class="anchor" href="#_targeter_target"></a><code>Targeter.target()</code></h3>
<div class="paragraph">
<p><code>Targeter</code> 接口有两个实现 <code>DefaultTargeter</code> 和 <code>HystrixTargeter</code>，根据是否配置熔断分开处理，最终都是执行 Feign.Builder 的 target方法。</p>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.DefaultTargeter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class DefaultTargeter implements Targeter {

    @Override
    public &lt;T&gt; T target(FeignClientFactoryBean factory, Feign.Builder feign,
            FeignContext context, Target.HardCodedTarget&lt;T&gt; target) {
        // 最终执行 Feign.Builder 的 target方法
        return feign.target(target);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.HystrixTargeter#target</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class HystrixTargeter implements Targeter {

    @Override
    public &lt;T&gt; T target(FeignClientFactoryBean factory, Feign.Builder feign,
            FeignContext context, Target.HardCodedTarget&lt;T&gt; target) {
        if (!(feign instanceof feign.hystrix.HystrixFeign.Builder)) {
            return feign.target(target);
        }
        feign.hystrix.HystrixFeign.Builder builder = (feign.hystrix.HystrixFeign.Builder) feign;
        String name = StringUtils.isEmpty(factory.getContextId()) ? factory.getName()
                : factory.getContextId();
        SetterFactory setterFactory = getOptional(name, context, SetterFactory.class);
        if (setterFactory != null) {
            builder.setterFactory(setterFactory);
        }
        Class&lt;?&gt; fallback = factory.getFallback();
        if (fallback != void.class) {
            return targetWithFallback(name, context, target, builder, fallback);
        }
        Class&lt;?&gt; fallbackFactory = factory.getFallbackFactory();
        if (fallbackFactory != void.class) {
            return targetWithFallbackFactory(name, context, target, builder,
                    fallbackFactory);
        }
        // 最终执行 Feign.Builder 的 target方法
        return feign.target(target);
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feigncontext"><a class="anchor" href="#_feigncontext"></a>FeignContext</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>FeignContext</code> 继承自 <code>NamedContextFactory</code> ，实现为每个 <code>@FeignClient</code> 标记的接口创建单独的子容器。</p>
</div>
<div class="sect2">
<h3 id="_初始化"><a class="anchor" href="#_初始化"></a>初始化</h3>
<div class="paragraph">
<p><code>FeignContext</code> 由 <code>FeignAutoConfiguration</code> 在启动时注入，<code>FeignAutoConfiguration</code> 被 <code>EnableConfigurationProperties</code> 修饰，启用对 <code>@ConfigurationProperties</code> 注释Bean的支持。。</p>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignAutoConfiguration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration(proxyBeanMethods = false)
@ConditionalOnClass(Feign.class)
@EnableConfigurationProperties({FeignClientProperties.class, FeignHttpClientProperties.class })
@Import(DefaultGzipDecoderConfiguration.class)
public class FeignAutoConfiguration {

    @Autowired(required = false)
    private List&lt;FeignClientSpecification&gt; configurations = new ArrayList&lt;&gt;();

    @Bean
    public HasFeatures feignFeature() {
        return HasFeatures.namedFeature("Feign", Feign.class);
    }

    @Bean
    public FeignContext feignContext() {
        // 注入 FeignContext
        FeignContext context = new FeignContext();
        context.setConfigurations(this.configurations);
        return context;
    }
    //..
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.openfeign.FeignContext#FeignContext</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FeignContext extends NamedContextFactory&lt;FeignClientSpecification&gt; {

    public FeignContext() {
		// FeignClientsConfiguration 是 Feign的默认全局配置
        super(FeignClientsConfiguration.class, "feign", "feign.client.name");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>通过调用父类的 <code>getInstance</code> 方法返回容器中的 <code>Bean</code>。</p>
</div>
<div class="listingblock">
<div class="title">org.springframework.cloud.context.named.NamedContextFactory#getInstance</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public &lt;T&gt; T getInstance(String name, Class&lt;T&gt; type) {
    // 先判断内存中有没有，有直接返回，没有会创建一个
    // 所有子容器保存在一个 ConcurrentHashMap 中
    AnnotationConfigApplicationContext context = getContext(name);
    if (BeanFactoryUtils.beanNamesForTypeIncludingAncestors(context,
            type).length &gt; 0) {
        return context.getBean(type);
    }
    return null;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置信息"><a class="anchor" href="#_配置信息"></a>配置信息</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_feignclientproperties"><a class="anchor" href="#_feignclientproperties"></a><code>FeignClientProperties</code></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ConfigurationProperties("feign.client")
public class FeignClientProperties {

	private boolean defaultToProperties = true;

	private String defaultConfig = "default";

	private Map&lt;String, FeignClientConfiguration&gt; config = new HashMap&lt;&gt;();

    //...
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/feign-client-properties.png" alt="feign client properties">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_feignhttpclientproperties"><a class="anchor" href="#_feignhttpclientproperties"></a><code>FeignHttpClientProperties</code></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ConfigurationProperties(prefix = "feign.httpclient")
public class FeignHttpClientProperties {

	/**
	 * Default value for disabling SSL validation.
	 */
	public static final boolean DEFAULT_DISABLE_SSL_VALIDATION = false;

	/**
	 * 默认 httpclient 最大连接数
	 */
	public static final int DEFAULT_MAX_CONNECTIONS = 200;

	/**
	 * 默认每个 FeignClient 最大连接数
	 */
	public static final int DEFAULT_MAX_CONNECTIONS_PER_ROUTE = 50;

	/**
	 * 默认存活时间
	 */
	public static final long DEFAULT_TIME_TO_LIVE = 900L;

	/**
	 * 默认超时时间
	 */
	public static final int DEFAULT_CONNECTION_TIMEOUT = 2000;

	/**
	 * 默认时间单位 s
	 */
	public static final TimeUnit DEFAULT_TIME_TO_LIVE_UNIT = TimeUnit.SECONDS;
    //...
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/feign-http-client-properties.png" alt="feign http client properties">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_总结"><a class="anchor" href="#_总结"></a>总结</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_流程图"><a class="anchor" href="#_流程图"></a>流程图</h3>
<div class="imageblock plantuml">
<div class="content">
<img src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuTBNLyZCIyufJKcriagjICmjo4bLAIueoinBrqtEoIzDqSqlICtJJKlDJC_JAm1gY8xbSaZDIm6o0000" alt="diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_时序图"><a class="anchor" href="#_时序图"></a>时序图</h3>
<div class="imageblock plantuml">
<div class="content">
<img src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuTBNLyZCIyufJKcriagjICmjo4bLIKlDJC_JAm1AHyToEQJcfG1P0000" alt="diagram">
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
